A publicly visible copy of the README for the Swarthmore habitat project. No code has been migrated into open source at this moment.

# habitat

Welcome to habitat!

Head over to the [wiki page](https://github.swarthmore.edu/CS71-F17/group-habitat/wiki) to learn more about this project.

## Table of Contents

* [Database Configuration](#databaseconfig)  
* [Database Loader](#databaseloader)
  * [Main YAML](#mainyaml)
  * [Geometry YAML](#geometryyaml)
* [Running Our Code](#running)
* [Web API](#webapi)
  * [URL Syntax](#urlsyntax)
  * [List of URLs](#urllist)
* [Web Application](#webapplication)
<a name="databaseconfig"/>

## Database Configuration

To configure your database connection in a local test environment, following the procedure below.

Copy [this](https://github.swarthmore.edu/CS71-F17/group-habitat/blob/master/setup/hibernate.properties) template properties file into the `habitat.data` directory. There are four keywords in the configuration file that must be replaced. For our purposes, we can use the credentials generated by the test database web portal provided by Zach on piazza: **URL, PORT, DATABASE_NAME, USER_NAME, PASSWORD**.

Your DATABASE_NAME is found by using the mysql client with the following commands:

```
$ mysql -u USER_NAME -h URL -p
Enter password:

Welcome to the MySQL monitor.  Commands end with ; or \g.
mysql> show databases;
```

Other handy MySQL terminal commands
```
# Once connected
mysql> use <DATABASE_NAME>;
mysql> show tables;
mysql> select * from Dormitory;
```

<a name="databaseloader"/>

## Database Loader

The habitat model has  a `HabitatDatabaseLoader` class that populates the
database with YAML files that are stored in the `habitat.data` directory.  

The location of the files can be found in the `developmentFiles.properties` file.
currently the structure is to have a `dorms.yaml` file located in `habitat.data/`.
This yaml file contains all of the info about each dorm. In addition, there is
a `habitat.data/geometry/` directory that contains all of the YAML files that have the geometry of each hall. Ex) `habitat.data/geometry/ParrishWest3.yaml `.  The halls follow the naming convention, `<DormName><HallName><floorNumber>.yaml`.

<a name="mainyaml"/>

#### Main YAML

The latest versions of these YAML files live on the swathabitat Google Drive `databaseFiles` directory. A smaller test file, `dormsSmall.yaml` is available for debugging purposes.

The structure for a single dorm.
```
!Dormitory
name: <DORM_NAME>
displayName: <DISPLAY_NAME>
halls:
  - !Hall
    name: <HALL_NAME>
    displayName: <DISPLAY_NAME>
    floorLevel: 1
    rooms:
    - !Room
      name: <ROOM_NAME>
      displayName: <DISPLAY_NAME>
      numResidents: 2
      roomStatus: OPEN
```

Mapping a YAML tag to a model class in `HabitatDatabaseLoader`
```
# TODO
```

<a name="geometryyaml"/>

#### Geometry YAML

This file is created in the `Serialize` method of the SVG module and observes the following syntax. Below is an example dorm.

```
!edu.swarthmore.cs71.habitat.model.geometry.HallGeometry
dormName: Danawell
floor: 1
hallName: ""
rooms:
- !edu.swarthmore.cs71.habitat.model.geometry.RoomGeometry
   roomNumber: 231
   walls:
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: &1
         xCoord: 266
         yCoord: 335
      b: &2
         xCoord: 383
         yCoord: 348
      elementsOnWall: []
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *2
      b: &3
         xCoord: 358
         yCoord: 528
      elementsOnWall: []
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *3
      b: &4
         xCoord: 238
         yCoord: 515
      elementsOnWall:
      - !edu.swarthmore.cs71.habitat.model.geometry.HallDoor
         dash1:
         - 2.0
         pt1:
            xCoord: 338
            yCoord: 526
         pt2:
            xCoord: 310
            yCoord: 523
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *4
      b: *1
      elementsOnWall: []
- !edu.swarthmore.cs71.habitat.model.geometry.RoomGeometry
   roomNumber: 229
   walls:
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *2
      b: &5
         xCoord: 505
         yCoord: 368
      elementsOnWall: []
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *5
      b: &6
         xCoord: 475
         yCoord: 551
      elementsOnWall: []
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *6
      b: *3
      elementsOnWall:
      - !edu.swarthmore.cs71.habitat.model.geometry.HallDoor
         dash1:
         - 2.0
         pt1:
            xCoord: 432
            yCoord: 543
         pt2:
            xCoord: 401
            yCoord: 537
   - !edu.swarthmore.cs71.habitat.model.geometry.Wall
      a: *3
      b: *2
      elementsOnWall: []

```

Note: The latest versions of the Geometry YAML files live on the yaml folder under core. In the future, these files will be moved to the Google Drive.

<a name="running"/>

## Running Tests
Run the all of the tests using intellij

## Running the Database Loader
This will run the database loader in isolation.
Follow the above instructions to check that the `dorms.yaml` is up to date.

Then run edu.swarthmore.cs71.habitat.persistence.HabitatDatabaseLoader.main

## Running Geometry Floor Plan Generation component.

Run edu.swarthmore.cs71.habitat.svg.gui.Launch.main

The GUI will prompt the user with places to enter all necessary info.

<a name="webapi"/>


## Running Web Application in a developing environment
The database will be autopopulated at the start of launching the spark
server.

Next run the server by running edu.swarthmore.cs71.habitat.webapp.spark.HabitatSparkDeveloperServer.main

Once the server is running, navigate to: 
```
localhost:34567/setUsername?username=student1
```
in a browser to login as student1, which is an account that has been pre-loaded in the database to have preferences, connections, and favorites. This will redirect you to localhost:34567/index.html, and you will be able to click through the webapp.



## Running Web Application in a production mode

To use the webapp, first run the server. In order to avoid re-running the
HabitatDatabaseLoader, in hibernate.properties, change the line that says:

```
hibernate.hbm2ddl.auto=create
```
to say "none" instead of "create".

Next run the server by running edu.swarthmore.cs71.habitat.webapp.spark.HabitatSparkServer.main

Once the server is running, navigate to localhost:34567/setUsername?username=anything in a browser, which will log you in as a user and redirect you to our home page, where you can begin clicking through the web app.

When done change the hibernate.properties file back to 
```
hibernate.hbm2ddl.auto=create
```
rather than "none"

## Web API

The server functions via HTTP requests. In javascript, these can be created with the $http.get("[URL]") command. This document lists all the HTTP get requests that the server is ready to take.

<a name="urlsyntax"/>

### URL Syntax
The HTTP requests are divided into two parts:

#### URL
Each HTTP get request comes with a URL that is effectively the method name: it determines the main instruction. Note that sparkjava speaks
about these URLs with a "/" in front of their name, while javascript does not. For example, the spark server is ready to receive the "/dormlist"
command, which javascript formulates with $http.get("dormlist")

#### Permission Level
Each HTTP request has a certain permission level, and will throw an error if the user does not have that permission level.
The following are the permission levels used:
* Account - this HTTP request will throw an error if it is done without being logged in: these requests generally just wouldn't make sense without an account
* Admin - this HTTP request will throw an error if it is done by a non-admin.

If a call is done by a user who is not logged in, it will automatically redirect them to the CAS login page.
For the URL descriptions below, assume each URL uses Account permission level unless it specifies Admin.

#### Parameters
Each HTTP request comes with parameters. Like with a normal method call, these are the inputs to the instruction.

#### Return
Each HTTP request returns either a javascript object or a list of them.

<a name="urllist"/>

### List of URLS

#### dormlist
* params: none
* returns a list of all dorms in the database as objects with the following fields:
  * name: The display name of the dorm
  * id: The unique database id of the dorm

#### setUsername
this is a "fake" URL: it won't be in the prod version, it only exists for testing. Immediately logs user in with a given username, bypassing CAS. Redirects to the homepage.
* param: username- the username to login as. If it doesn't exist, the account for this user will be created.
* returns: 0 on success
* example: http://localhost:34567/setUsername?username=anything

#### getUsername
* params: none
* returns: the username in the current session

#### getAccount
* params: none
* returns info about the *currently logged in* user. Returns an object with the following fields:
 * name: the username
  * admin: true or false
  * privacy: the type of privacy the account has set
  * room: the user's current room, if there is one. If there is, this object has fields for displayName and id

#### addDorm
* params: 
 * name: the name of the dorm, lowercase only, no spaces
  * displayName: the name of the dorm how it will be displayed
* permission: admin
* adds the given dorm to the database, with no floorplans

#### login
redirects to CAS to resolve login. Upon return, it will ensure an account for that user exists: if it does not, it will be created.
* params: none

#### validateTicket
only used within login usecase. Lets us validate the username that has logged in.

#### logout
logs out currently logged in user
* params: none

#### getFavorites
* param: username- the username whose favorites to return
* returns a list of objects representing the users' favorited rooms with the following fields:
* field: name: the room's display name
* field: hall: the room's hall's display name
* field: id: the database id of the room
* _if the currently logged in user has not been given permission to access the input user's favorites, will return error code 1_

#### getConnections
* param username: the username whose connections to return
* returns a list of objects representing the users' connections with the following field:
 * field: name: the connection's username (the person with whom their data has been shared)
 * _if the currently logged in user has not been given permission to access the input user's connections, will return error code 1_

#### getRoom
* params: roomId: the id of the room in question
* returns an object conveying the room's state with these fields:
* field: status: "available" "blocked" "taken" "claimed" "unknown"
* field: block: id of the block the room is part of, or -1 if not part of a block
* field: taker: username of the person who claimed the room. null if not applicable, "anonymous" if not visible to currently logged in user
* field: points: the coordinates of all points making up the room corners. Each has two fields, x and y. The first and last point are the same.
 * field: doors: the coordinates of all doors. Each has the following structure: {p1:{x,y}, p2:{x,y}, direction:[CW or CCW]}

#### getDorm
* param: dormId: the database id of the dorm in question
* returns an object conveying information about the dorm, with the following fields
* field: name: the dorm name
* field: displayName: the name as it should be presented
* field: floors: list of objects representing the floors of the dorm, each with the following fields:
 * subfield: name: the name of the floor
 * subfield: id: the database id of the floor

#### getFloorplan
* param: floorId: the database id of the floor in question
* returns an svg of the floorplan. Does not contain any other meta info: for that, see getHall below

#### getHall
* param: hallId
* returns an object with the following fields
* field: rooms - an array of json objects, each containing fields "name", "id", and "status"

  
#### getAmenitiesOptions
* params:none
* returns a JSON Object containing list of all possible amenity types and their selection options
* field: name: amenity name (ex. BathroomType)
* field: options: selection options (ex. Gender Neutral, Single-Use, Communal)

#### addConnection

#### deleteConnection

#### claimRoom
* param: roomId - the id of the room to claim
* claims the room for the currently logged in user
* throws exception if the user already has a room claimed


#### registerFloorplanClick
* param: x - the x coordinate of the click
* param: y - the y coordinate of the click
* param: floorId - the id of the floorplan in question
* permission: none
* returns a JSON object with the following fields:
* field: roomId (the id of the room in question) (-1 if no such room)

#### addFavorite
* param: roomId - id of the room to add as favorite
* adds room to favorites list for logged in user
* returns 0 on success

#### deleteFavorite
* not yet implemented

#### unclaimRoom
* params: none
clears the currently logged in user's claimed room
returns the roomId that used to be claimed
throws error if no such room existed

#### addPreferenceRoute
* not yet implemented

#### getHallAmenities
* params: hallId - id of the hall to view
* returns list of amenities the hall has

#### getRoomAmenities
* params: roomId
* returns list of amenities the room has

#### getRoomGeometry
* params: roomId - id of room to get floorplan for
* returns svg of floorplan for room

#### getConnections
* params: username
* returns list of connection usernames for user

#### setAdmin
* params: username
* permission: admin
* makes the given username an admin

#### getRoomMatches
* returns a list of rooms that match the current user's preferences

## Run On VM35
- ssh vm35.cs.swarthmore.edu
- clone project (set up public/private key if not already)
- `mvn install` in each module
- follow setup instructions for hibernate
- `mvn -f webapp/pom.xml exec:java -Dexec.mainClass="edu.swarthmore.cs71.habitat.webapp.spark.HabitatSparkDevelopmentServer"`

<a name="webapplication"/>
